!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndoorEqual=t()}(this,function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function r(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(e,t,i){return(t=c(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?o(Object(i),!0).forEach(function(t){n(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function s(e,t){if(null==e)return{};var i,r,n=function(e,t){if(null==e)return{};var i={};for(var r in e)if({}.hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;i[r]=e[r]}return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)i=o[r],-1===t.indexOf(i)&&{}.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function l(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(t,i){if(t){if("string"==typeof t)return e(t,i);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,i):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}var h=function(){return r(function e(i){var r=this;t(this,e),this.indoorequal=i,this._cbRefresh=function(){return r._refresh()},this.indoorequal.on("levelschange",this._cbRefresh),this.indoorequal.on("levelchange",this._cbRefresh),this.$el=document.createElement("div"),this.$el.classList.add("maplibregl-ctrl","maplibregl-ctrl-group","maplibregl-ctrl-indoorequal"),this._refresh()},[{key:"destroy",value:function(){this.$el.remove(),this.indoorequal.off("levelschange",this._cbRefresh),this.indoorequal.off("levelchange",this._cbRefresh)}},{key:"_refresh",value:function(){var e=this;this.$el.innerHTML="",this.indoorequal.levels.forEach(function(t){var i=document.createElement("button"),r=document.createElement("strong");r.textContent=t,i.appendChild(r),t==e.indoorequal.level&&i.classList.add("maplibregl-ctrl-active"),i.addEventListener("click",function(){e.indoorequal.setLevel(t)}),e.$el.appendChild(i)})}}])}(),u={type:"symbol","source-layer":"poi",layout:{"icon-image":["coalesce",["image",["concat",["literal","indoorequal-"],["get","subclass"]]],["image",["concat",["literal","indoorequal-"],["get","class"]]]],"text-anchor":"top","text-field":["case",["==",["get","class"],"aeroway"],["get","ref"],["concat",["get","name:latin"],"\n",["get","name:nonlatin"]]],"text-max-width":9,"text-offset":[0,.6],"text-padding":2,"text-size":12},paint:{"text-color":"#666","text-halo-blur":.5,"text-halo-color":"#ffffff","text-halo-width":1}},f=["waste_basket","information","vending_machine","bench","photo_booth","ticket_validator"],d=[{id:"indoor-polygon",type:"fill","source-layer":"area",filter:["all",["==","$type","Polygon"],["!=","class","level"]],paint:{"fill-color":["case",["all",["has","access"],["in",["get","access"],["literal",["no","private"]]]],"#F2F1F0",["any",["all",["==",["get","is_poi"],!0],["!=",["get","class"],"corridor"]],["in",["get","subclass"],["literal",["class","laboratory","office","auditorium","amphitheatre","reception"]]]],"#D4EDFF",["==",["get","class"],"room"],"#fefee2","#fdfcfa"]}},{id:"indoor-area",type:"line","source-layer":"area",filter:["all",["in","class","area","corridor","platform"]],paint:{"line-color":"#bfbfbf","line-width":1}},{id:"indoor-column",type:"fill","source-layer":"area",filter:["all",["==","class","column"]],paint:{"fill-color":"#bfbfbf"}},{id:"indoor-lines",type:"line","source-layer":"area",filter:["all",["in","class","room","wall"]],paint:{"line-color":"gray","line-width":2}},{id:"indoor-transportation",type:"line","source-layer":"transportation",filter:["all"],paint:{"line-color":"gray","line-dasharray":[.4,.75],"line-width":{base:1.4,stops:[[17,2],[20,10]]}}},{id:"indoor-transportation-poi",type:"symbol","source-layer":"transportation",filter:["all",["in","$type","Point","LineString"],["in","class","steps","elevator","escalator"]],layout:{"icon-image":["case",["has","conveying"],"indoorequal-escalator",["concat",["literal","indoorequal-"],["get","class"]]],"symbol-placement":"line-center","icon-rotation-alignment":"viewport"}},a(a({id:"indoor-poi-rank1"},u),{},{filter:["all",["==","$type","Point"],["!in","class"].concat(f)]}),a(a({id:"indoor-poi-rank2"},u),{},{minzoom:19,filter:["all",["==","$type","Point"],["in","class"].concat(f)]}),{id:"indoor-heat",type:"heatmap","source-layer":"heat",filter:["all"],paint:{"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(102, 103, 173, 0)",.1,"rgba(102, 103, 173, 0.2)",1,"rgba(102, 103, 173, 0.7)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,3,13,20,17,40],"heatmap-intensity":1,"heatmap-opacity":["interpolate",["linear"],["zoom"],16,1,17.1,0]}},{id:"indoor-name",type:"symbol","source-layer":"area_name",filter:["all"],layout:{"text-field":["concat",["coalesce",["get","name:latin"],["get","ref"]],"\n",["get","name:nonlatin"]],"text-max-width":5,"text-size":14},paint:{"text-color":"#666","text-halo-color":"#ffffff","text-halo-width":1}}];function p(e,t,i,r){var n=t.width,o=t.height;if(r){if(r instanceof Uint8ClampedArray)r=new Uint8Array(r.buffer);else if(r.length!==n*o*i)throw new RangeError("mismatched image size")}else r=new Uint8Array(n*o*i);return e.width=n,e.height=o,e.data=r,e}function y(e,t,i,r,n,o){if(0===n.width||0===n.height)return t;if(n.width>e.width||n.height>e.height||i.x>e.width-n.width||i.y>e.height-n.height)throw new RangeError("out of range source coordinates for image copy");if(n.width>t.width||n.height>t.height||r.x>t.width-n.width||r.y>t.height-n.height)throw new RangeError("out of range destination coordinates for image copy");for(var a=e.data,s=t.data,l=0;l<n.height;l++)for(var c=((i.y+l)*e.width+i.x)*o,h=((r.y+l)*t.width+r.x)*o,u=0;u<n.width*o;u++)s[h+u]=a[c+u];return t}var v=function(){function e(i,r){t(this,e),p(this,i,4,r)}return r(e,[{key:"resize",value:function(e){!function(e,t,i){var r=t.width,n=t.height;if(r!==e.width||n!==e.height){var o=p({},{width:r,height:n},i);y(e,o,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,r),height:Math.min(e.height,n)},i),e.width=r,e.height=n,e.data=o.data}}(this,e,4)}},{key:"replace",value:function(e,t){t?this.data.set(e):e instanceof Uint8ClampedArray?this.data=new Uint8Array(e.buffer):this.data=e}},{key:"clone",value:function(){return new e({width:this.width,height:this.height},new Uint8Array(this.data))}}],[{key:"copy",value:function(e,t,i,r,n){y(e,t,i,r,n,4)}}])}();function m(e){var t,i,r=window.devicePixelRatio>1?"@2x":"",n=fetch("".concat(e).concat(r,".json")).then(function(e){return e.json()}).then(function(e){return t=e}),o=fetch("".concat(e).concat(r,".png")).then(function(e){return e.blob()}).then(function(e){return(i=new Image).src=URL.createObjectURL(e),new Promise(function(e,t){i.onload=function(){return e()},i.onerror=function(){return t()}})});return Promise.all([n,o]).then(function(){var e=function(e){var t=window.document.createElement("canvas"),i=t.getContext("2d");if(!i)throw new Error("failed to create canvas 2d context");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0,e.width,e.height),i.getImageData(0,0,e.width,e.height)}(i),r={};for(var n in t){var o=t[n],a=o.width,s=o.height,l=o.x,c=o.y,h=o.sdf,u=o.pixelRatio,f=o.stretchX,d=o.stretchY,p=o.content,y=new v({width:a,height:s});v.copy(e,y,{x:l,y:c},{x:0,y:0},{width:a,height:s}),r[n]={data:y,pixelRatio:u,sdf:h,stretchX:f,stretchY:d,content:p}}return r})}var g=["data"],b=function(){return r(function e(i){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e);var n=a(a({},{layers:d,geojson:{}}),r);this.map=i,this.geojson=n.geojson,this.layers=n.layers,this.baseSourceId="indoorequal",this.sourceId="".concat(this.baseSourceId,"_area")},[{key:"addSource",value:function(){var e=this;Object.keys(this.geojson).forEach(function(t){e.map.addSource("".concat(e.baseSourceId,"_").concat(t),{type:"geojson",data:e.geojson[t]})})}},{key:"addLayers",value:function(){var e=this,t=Object.keys(this.geojson),i=this.layers;this.layers=i.filter(function(e){return t.includes(e["source-layer"])}),this.layers.forEach(function(t){e.map.addLayer(a(a({source:"".concat(e.baseSourceId,"_").concat(t["source-layer"])},t),{},{"source-layer":""}))})}},{key:"remove",value:function(){var e=this;this.layers.forEach(function(t){e.map.removeLayer(t.id)}),Object.keys(this.geojson).forEach(function(t){e.map.removeSource("".concat(e.baseSourceId,"_").concat(t))})}}])}(),w=function(){return r(function e(i){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e);var n={url:"https://tiles.indoorequal.org/",layers:d},o=a(a({},n),r);if(o.url===n.url&&!o.apiKey)throw"You must register your apiKey at https://indoorequal.com before and set it as apiKey param.";this.map=i,this.url=o.url,this.apiKey=o.apiKey,this.layers=o.layers,this.sourceId="indoorequal"},[{key:"addSource",value:function(){var e=this.apiKey?"?key=".concat(this.apiKey):"";this.map.addSource(this.sourceId,{type:"vector",url:"".concat(this.url).concat(e)})}},{key:"addLayers",value:function(){var e=this;this.layers.forEach(function(t){e.map.addLayer(a({source:e.sourceId},t))})}},{key:"remove",value:function(){var e=this;this.layers.forEach(function(t){e.map.removeLayer(t.id)}),this.map.removeSource(this.sourceId)}}])}(),_=function(){return r(function e(i){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e);var o=n.geojson?b:w,s=a(a({},{heatmap:!0}),n);this.source=new o(i,n),this.map=i,this.levels=[],this.level="0",this.events={},this._loadSprite=m,this.map.isStyleLoaded()?(this._init(),this.setHeatmapVisible(s.heatmap)):this.map.once("load",function(){r._init(),r.setHeatmapVisible(s.heatmap)})},[{key:"remove",value:function(e){e||this.source.remove(),this._updateLevelsDebounce.clear(),this.map.off("load",this._updateLevelsDebounce),this.map.off("data",this._updateLevelsDebounce),this.map.off("move",this._updateLevelsDebounce),this._control&&this.onRemove()}},{key:"on",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}},{key:"off",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e]=this.events[e].filter(function(e){return e!==t})}},{key:"onAdd",value:function(){return this._control=new h(this),this._control.$el}},{key:"onRemove",value:function(){this._control.destroy(),this._control=null}},{key:"setLevel",value:function(e){this.level=e,this._updateFilters(),this._emitLevelChange()}},{key:"updateLevel",value:function(e){console.log("The updateLevel method is deprecated. Please use setLevel instead."),this.setLevel(e)}},{key:"loadSprite",value:function(e){var t=this,i=a({update:!1},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return this._loadSprite(e).then(function(e){for(var r in e){var n=e[r],o=n.data,a=s(n,g);t.map.hasImage(r)?i.update&&t.map.updateImage(r,o):t.map.addImage(r,o,a)}return e})}},{key:"setHeatmapVisible",value:function(e){this.map.getLayer("indoor-heat")&&this.map.setLayoutProperty("indoor-heat","visibility",e?"visible":"none")}},{key:"_init",value:function(){var e=this;this.source.addSource(),this.source.addLayers(),this._updateFilters(),this._updateLevelsDebounce=function(e,t=100,i={}){if("function"!=typeof e)throw new TypeError(`Expected the first parameter to be a function, got \`${typeof e}\`.`);if(t<0)throw new RangeError("`wait` must not be negative.");if("boolean"==typeof i)throw new TypeError("The `options` parameter must be an object, not a boolean. Use `{immediate: true}` instead.");const{immediate:r}=i;let n,o,a,s,l;function c(){const t=n,i=o;return n=void 0,o=void 0,l=e.apply(t,i),l}function h(){const e=Date.now()-s;e<t&&e>=0?a=setTimeout(h,t-e):(a=void 0,r||(l=c()))}const u=function(...e){if(n&&this!==n&&Object.getPrototypeOf(this)===Object.getPrototypeOf(n))throw new Error("Debounced method called with different contexts of the same prototype.");n=this,o=e,s=Date.now();const i=r&&!a;if(a||(a=setTimeout(h,t)),i)return l=c(),l};return Object.defineProperty(u,"isPending",{get:()=>void 0!==a}),u.clear=()=>{a&&(clearTimeout(a),a=void 0,n=void 0,o=void 0)},u.flush=()=>{a&&u.trigger()},u.trigger=()=>{l=c(),u.clear()},u}(this._updateLevels.bind(this),1e3),this.map.on("load",this._updateLevelsDebounce),this.map.on("data",this._updateLevelsDebounce),this.map.on("move",this._updateLevelsDebounce),this.map.on("remove",function(){e.remove(!0)})}},{key:"_updateFilters",value:function(){var e=this;this.source.layers.filter(function(e){return"heatmap"!==e.type}).forEach(function(t){e.map.setFilter(t.id,[].concat(l(t.filter||["all"]),[["==","level",e.level]]))})}},{key:"_refreshAfterLevelsUpdate",value:function(){this.levels.includes(this.level)||this.setLevel("0")}},{key:"_updateLevels",value:function(){if(this.map.isSourceLoaded(this.source.sourceId)){var e=function(e){for(var t=[],i=0;i<e.length;i++){var r=e[i];if("level"!==r.properties.class){var n=r.properties.level;t.includes(n)||t.push(n)}}return t.sort(function(e,t){return e-t}).reverse()}(this.map.querySourceFeatures(this.source.sourceId,{sourceLayer:"area"}));(function(e,t){if(e===t)return!0;const{length:i}=e;if(i!==t.length)return!1;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0})(e,this.levels)||(this.levels=e,this._emitLevelsChange(),this._refreshAfterLevelsUpdate())}}},{key:"_emitLevelsChange",value:function(){this._emitEvent("levelschange",this.levels)}},{key:"_emitLevelChange",value:function(){this._emitEvent("levelchange",this.level)}},{key:"_emitEvent",value:function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];(this.events[e]||[]).forEach(function(e){return e.apply(void 0,i)})}}])}();return _});
//# sourceMappingURL=maplibre-gl-indoorequal.umd.min.js.map
